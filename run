#!/bin/bash

dir=$PWD
cd /vagrant
RUN_RAKE=1
if [ -d mushroom-observer ];
	then
		cd mushroom-observer
		if [ "`git pull`" = "Already up-to-date." ]; then RUN_RAKE=0; fi
	else
		git clone https://github.com/MushroomObserver/mushroom-observer.git
		cd mushroom-observer
		mysql -u root -proot < db/initialize.sql # Move to config-script?
		mysql -u mo -pmo mo_development < $dir/config-script/init.sql
    mkdir public/images/{thumb,320,640,960,1280,orig}
fi

cp $dir/config-script/database.yml config

apt-get install -y -q imagemagick libmagickcore-dev libmagickwand-dev libjpeg-dev libjpeg-progs
# gem install rmagick --verbose --no-rdoc --no-ri --conservative

# Althrough it should be safe to run these, making it conditional to avoid
# a race condition with mysql becoming available.  If mysql reports a failure,
# go to the vagrant box and run these commands by hand.
# if [ "$RUN_RAKE" = 1 ]; then bundle install; rake db:migrate; rake lang:update; fi

if [ ! -f /usr/local/bin/jpegresize ];
	then
		gcc script/jpegresize.c -ljpeg -lm -O2 -o /usr/local/bin/jpegresize
fi
if [ ! -f /usr/local/bin/jpegexiforient ];
	then
	  gcc script/jpegexiforient.c -o /usr/local/bin/jpegexiforient
fi
if [ ! -f /usr/local/bin/exifautotran ];
	then
    cp script/exifautotran.sh /usr/local/bin/exifautotran; chmod 755 /usr/local/bin/exifautotran
fi

chown -R vagrant:vagrant /vagrant/mushroom-observer
